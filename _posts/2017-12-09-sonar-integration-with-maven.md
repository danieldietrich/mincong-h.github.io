---
layout:      post
title:       "Sonar Integration with Maven"
date:        "2017-12-09 17:23:09 +0100"
categories:  [maven, java, code-quality, jenkins, sonar]
comments:    true
---

<p align="center">
  <img src="{{ site.url }}/assets/logo-sonarsource.svg"
       alt="Logo SonarSource"
       style="max-width: 50%; margin: 3em auto 2em auto;">
</p>

Today, I would like to share how to configure your Java project with Maven and
Sonar, a powerful tool for continuous code quality analysis.

SonarQube provides the capability to not only show health of an application but
also to highlight issues newly introduced. With a Quality Gate in place, you can
fix the leak and therefore improve code quality systematically. Sonar code
analyzers are equipped powerful path sensitive dataflow engines to detect tricky
issues such as null-pointers dereferences, logic errors, resource leaks...

They have also an online version, [Sonar Cloud][sonar-cloud], which allows you
to upload the analyse result without hosting the SonarQube server yourself.
Here's an example coming from my own project _"Alumni Server"_:

<p align="center">
  <img src="{{ site.url }}/assets/20171209-sonarcloud.io-example.png"
       alt="Sonar analysis example 'Alumni Server'"
       style="border-radius: 0">
  <figcaption>Figure 1: Sonar analysis example "Alumni Server"</figcaption>
</p>

## Maven Configuration

There're 2 parts that we need to configure in Maven:

- Plugin management: define the behaviors of Sonar and [JaCoCo][jacoco].
- Profile: define a profile for SonarCloud execution

In the Maven `<pluginManagement>` section, we need to configure the default
behaviors of Sonar plugin, meaning that we define the version used, the goal
binding of Sonar scanner. Binding `sonar:sonar` to verify helps us the
facilitate the code analysis: sonar will be executed any Maven command in which
phase `verify` is included. In the same time, we also define JaCoCo, a Maven
plugin for detecting the test coverage of unit tests and integration tests,
using respectively the goals `prepare-agent` and `prepare-agent-integration`.
Test coverage report will be generated by goal `report`.

{% highlight xml %}
<pluginManagement>
  <plugins>
    <plugin>
      <groupId>org.sonarsource.scanner.maven</groupId>
      <artifactId>sonar-maven-plugin</artifactId>
      <version>3.3.0.603</version>
      <executions>
        <execution>
          <phase>verify</phase>
          <goals>
            <goal>sonar</goal>
          </goals>
        </execution>
      </executions>
    </plugin>
    <plugin>
      <groupId>org.jacoco</groupId>
      <artifactId>jacoco-maven-plugin</artifactId>
      <version>0.7.9</version>
      <configuration>
        <append>true</append>
      </configuration>
      <executions>
        <execution>
          <id>prepare-agent</id>
          <goals>
            <goal>prepare-agent</goal>
          </goals>
        </execution>
        <execution>
          <id>prepare-agent-integration</id>
          <goals>
            <goal>prepare-agent-integration</goal>
          </goals>
        </execution>
        <execution>
          <id>jacoco-site</id>
          <phase>verify</phase>
          <goals>
            <goal>report</goal>
          </goals>
        </execution>
      </executions>
    </plugin>
  </plugins>
</pluginManagement>
{% endhighlight %}

In the Maven `<profile>` section, create a new profile for Sonar code analysis.
You need to define certain [Sonar analysis parameters][sonar-params], in order
to match your SonarQube instance requirements.

{% highlight xml %}
<profile>
  <id>sonar</id>
  <properties>
    <sonar.host.url>https://sonarcloud.io</sonar.host.url>
    <sonar.organization>mincong-h-github</sonar.organization>
  </properties>
  <build>
    <plugins>
      <plugin>
        <groupId>org.jacoco</groupId>
        <artifactId>jacoco-maven-plugin</artifactId>
      </plugin>
      <plugin>
        <groupId>org.sonarsource.scanner.maven</groupId>
        <artifactId>sonar-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>
</profile>
{% endhighlight %}

Once every configuration is ready, you can run Sonar code analysis alongside
with all the tests as following in your local machine, where `SONAR_LOGIN_TOKEN`
is the [authentication token][sonar-token] of a SonarQube user with
_Execute Analysis_ permission:

    mvn clean verify -P sonar \
        -Dsonar.login=$SONAR_LOGIN_TOKEN

## Jenkins Configuration

Now, let's take a look about how to configure Sonar analysis as part of the
Jenkins job. Notice that for Git repository, by default, Sonar only runs
analysis on _master_ branch. Therefore, the Sonar analysis should only be bound
to the Jenkins job running for _master_.

- Modify an existing Jenkins job or create a new one for _master_
- Enable option _"Use secret text(s) or file(s)"_
- Add binding of type _"Username and password (separated)"_
  - Keep _"Username variable"_ empty
  - Name _"Password variable"_ as `$SONAR_LOGIN_TOKEN`
  - Credentials of type _"Specific credentials"_ and select the Sonar one from
    from the list.
- Build as **maven-3** with goals and options:

      clean verify -P sonar -Dsonar.login=$SONAR_LOGIN_TOKEN

Now, your Jenkins job is ready and you should be able to see your code analysis
on Sonar cloud. Notice that, if the target project does not exist on SonarQube,
SonarQube will create it for you automatically after the first analysis report
upload.

## Next Steps

Now we've successfully configured the Sonar scanner in Maven for the first
analysis. As for the next steps, I think you might be interested in:

- Exploring the analysis results in Sonar
- Replace classical Jenkins job by [`Jenkinsfiles`][jenkinsfiles] pipeline
- Configure GitHub integration of Sonar auto-reply in pull requests

They're the future topics that I might be presented in my blog. Thanks for your
attention. Please stay tuned!

## References

- [Jenkins - Using a Jenkinsfile][jenkinsfiles]
- [Sonar Cloud][sonar-cloud]
- [JaCoCo Maven plugin][jacoco]

[jenkinsfiles]: https://jenkins.io/doc/book/pipeline/jenkinsfile/
[sonar-cloud]: https://sonarcloud.io/
[sonar-params]: https://docs.sonarqube.org/display/SONAR/Analysis+Parameters
[sonar-token]: https://docs.sonarqube.org/display/SONAR/User+Token
[jacoco]: http://www.eclemma.org/jacoco/trunk/doc/maven.html
